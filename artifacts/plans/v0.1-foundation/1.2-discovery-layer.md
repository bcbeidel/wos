---
document_type: plan
description: "Implement the discovery layer that auto-generates CLAUDE.md manifest sections and rules files from context documents on disk"
last_updated: 2026-02-17
status: draft
related:
  - artifacts/plans/v0.1-foundation/1.1-document-type-models.md
  - artifacts/research/v0.1-foundation/2026-02-17-skills-architecture-design.md
---

# Implement Discovery Layer

## Objective

A Python module exists at `wos/discovery.py` that scans a project's
`/context/` directory, reads frontmatter from context documents (topics +
overviews), and generates two outputs: a CLAUDE.md manifest section (markdown
between markers under a `## Context` heading) and a rules file
(`.claude/rules/work-os-context.md`). Both are regenerated deterministically
from disk state.

Running `python3 scripts/run_discovery.py` (or with `--root /path`) produces
correct, current discovery artifacts every time.

## Context

- Discovery layer design: `artifacts/research/v0.1-foundation/2026-02-17-skills-architecture-design.md` §2
- Depends on document type models for frontmatter parsing
- CLAUDE.md manifest is context-types only (topics + overviews)
- Artifacts (research, plans) are not in the manifest — reachable via `related` links
- Marker format: `<!-- work-os:context:begin -->` / `<!-- work-os:context:end -->`
- Manifest lives under a `## Context` heading in CLAUDE.md
- Manifest format: H3 per area, overview link, topic table with descriptions
- If CLAUDE.md doesn't exist, create it using Claude Code best practices
- Rules file is a compact behavioral guide for agents in the target repo
- Default root is CWD; override with `--root`

## Steps

1. Implement `scan_context(root)` in `wos/discovery.py` — walk the
   `/context/` directory, parse frontmatter from each `.md` file using
   `parse_document()`, return structured data: list of areas, each with overview
   metadata and list of topic metadata (path, title, description)

2. Implement `render_manifest(areas)` — generate the markdown manifest section:
   one H3 per area, overview link, topic table with Description column.
   Output is the content between markers (not including markers themselves).
   Example output:
   ```
   ### Python

   [Overview](context/python/_overview.md)

   | Topic | Description |
   |-------|-------------|
   | [Error Handling](context/python/error-handling.md) | When and how to use exceptions |
   ```

3. Implement `update_claude_md(file_path, manifest_content)` — read existing
   CLAUDE.md, find markers, replace content between them. If no markers exist,
   add a `## Context` heading with markers + content. If file doesn't exist,
   create it with a best-practices template (project header, build & test
   section, `## Context` with markers)

4. Implement `render_rules_file()` — generate a compact behavioral guide for
   agents working in the target repo: document types and their directories,
   frontmatter requirements, when to create each type, how to use `related`
   links, pointer to `/wos:` skills for content operations. Under 50 lines,
   actionable only

5. Implement `update_rules_file(root, content)` — write to
   `.claude/rules/work-os-context.md`, creating directory if needed

6. Create `scripts/run_discovery.py` — thin CLI entry point:
   `python3 scripts/run_discovery.py [--root ROOT]` runs scan → render manifest
   → update CLAUDE.md → render rules → update rules file. Defaults to CWD.
   Handle both `python` and `python3` invocations gracefully.

7. Implement `update_agents_md(file_path, manifest_content)` — same marker
   logic as CLAUDE.md, mirrored content for AGENTS.md

8. Write tests in `tests/test_discovery.py` using inline strings: empty
   context directory produces empty manifest, single area with topics produces
   correct table, user content outside markers preserved, markers added to
   existing file without markers, rules file content is under 50 lines,
   CLAUDE.md created from scratch when missing

## Verification

- `python3 scripts/run_discovery.py` produces a CLAUDE.md with correct manifest
  under `## Context`
- Existing content outside markers in CLAUDE.md is preserved after regeneration
- Rules file at `.claude/rules/work-os-context.md` exists and is under 50 lines
- Running discovery twice produces identical output (idempotent)
- AGENTS.md contains the same manifest content as CLAUDE.md
- CLAUDE.md is created with a best-practices template when it doesn't exist
